#textdomain wesnoth-wov
# This scenario is intended to be medium->hard difficulty.
[scenario]
    id=07_Elensefar
    name= _ "Elensefar"
    next_scenario=08_Wesmere
    {WOV_MAP 07_Elensefar.map} # L Unlawful Orders map, made younger, with autumn trees, less villages, dirt roads, encampment instead of castle, wood instead of stone.
    {TURNS 22 20 18}
    {DEFAULT_SCHEDULE_DUSK} # It's autumn
    victory_when_enemies_defeated=no
    carryover_percentage=40
    carryover_add=yes

    {INTRO_AND_SCENARIO_MUSIC revelation.ogg loyalists.ogg}
    {EXTRA_SCENARIO_MUSIC the_city_falls.ogg}
    {EXTRA_SCENARIO_MUSIC the_king_is_dead.ogg}

    [story]
        [part]
            story= _ "Galun sent the remaining messengers from the other flights back to report on the success of finding a way to the Great Continent."
        [/part]
        [part]
            story= _ "From above The Three Sisters, the keenest eyes in the flight saw a hint of a great range of mountains to the east and north over the water, such country as Drakes love to build eyries in."
        [/part]
        [part]
            story= _ "With the mainland near, shorter flights with heavier loads could be made. Thus with the fire from the volcanoes the drakes reforged their heavier tools and armor for the clashers."
        [/part]
        [part]
            background=story/landscape-mountains-03.jpg
            story= _ "When everyone was ready, Galun ordered the flight toward the mountains. On their way, a settlement was spotted."
        [/part]
    [/story]
    {WOV_GC_TRACK {JOURNEY_07_NEW}}

    # wmllint: validate-off
    [side]
        side=1
        controller=human
        recruit=Drake Burner, Drake Clasher, Drake Fighter, Drake Glider, Saurian Augur, Saurian Skirmisher #Allow clashers again
        gold=150
        save_id=Player
        team_name=hero
        user_team_name= _ "Drakes"
        side_name= _ "Galun"
        {FLAG_VARIANT long}
        [leader]
            {GALUN}
        [/leader]
        [unit]
            {VANK}
            placement=leader
        [/unit]
        [unit]
            {ARINEXIS}
            placement=leader
        [/unit]
        [unit]
            {KRENIX}
            placement=leader
        [/unit]
    [/side]
    {SECOND_INTENDANT_REPLACEMENT_EVENTS}
    {WOV_DEATHS}

    [side]
        side=2
        controller=ai
        recruit=Cavalryman, Dragoon, Horseman, Lancer, Knight, Spearman, Swordsman, Pikeman, Bowman, Longbowman, White Mage
        {GOLD 250 300 350}
        {INCOME 15 20 25}
        team_name=humans
        user_team_name= _ "Humans"
        {FLAG_VARIANT loyalist}
        [leader]
            id=Vorlyan
            name= _ "Vorlyan"
            type=General
            facing=se
        [/leader]
        [ai]
            recruitment_pattern=fighter,fighter,mixed fighter,archer,archer,healer,scout
        [/ai]
    [/side]
    {STARTING_VILLAGES 2 16}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 2 "Horseman, Lancer, Knight, Pikeman, Longbowman, White Mage" 3} # So there is a mix that encourages clasher line use
    {LIMIT_CONTEMPORANEOUS_RECRUITS 2 "Bowman" 3}

    [side]
        side=3
        controller=ai
        recruit=Drake Burner, Drake Clasher, Drake Fighter, Drake Glider
        gold=0
        team_name=hero
        user_team_name= _ "Drakes"
        side_name= _ "Kerath"
        {FLAG_VARIANT long}
        # This ensures the leader participates in the attack to take the keep
        [ai]
            ai_algorithm=experimental_ai
            aggression=0.75
            leader_aggression=0.75
            leader_ignores_keep=yes
            [leader_goal]
                x,y=16,13 #enemy keep
                auto_remove=yes
                id=land_on_keep
                max_risk=1
            [/leader_goal]
        [/ai]
    [/side]
    # wmllint: validate-on
    [event]
        name=moveto
        [filter]
            id=Kerath
            x,y=16,13
        [/filter]
        # Restore default values since the keep has been taken
        [modify_side]
            side=3
            [ai]
                leader_aggression=-4.0
                leader_ignores_keep=no
            [/ai]
        [/modify_side]
    [/event]

    [event]
        name=prestart

        {MODIFY_UNIT side=1 facing nw}

        # Return the clashers from from The Contention
        [foreach]
            array=clashers
            variable=this_unit
            [do]
                [unstore_unit]
                    variable=this_unit
                    x,y=recall,recall
                [/unstore_unit]
            [/do]
        [/foreach]
        {CLEAR_VARIABLE clashers}

        # Place the brazier
        [terrain]
            terrain=^Eb
            x,y=14,41
            layer=overlay
        [/terrain]

        [objectives]
            [objective]
                description= _ "Kill all enemy units"
                condition=win
            [/objective]
            [objective]
                description= _ "Death of Galun"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Vank"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Kerath"
                condition=lose
            [/objective]
            {TURNS_RUN_OUT}
            [gold_carryover]
                bonus=yes
                carryover_percentage=40
            [/gold_carryover]
            [note]
                description= _ "Clashers are available again to recruit and recall."
            [/note]
            [note]
                description= _ "Kerath’s Flight will aid you when the brazier is lit. Move a unit adjacent to the brazier to light it."
            [/note]
        [/objectives]
    [/event]

    [event]
        name=start
        [message]
            speaker=Vank
            message= _ "A village full of runners is ahead."
        [/message]
        [message]
            speaker=Galun
            message= _ "Call the hunt!"
        [/message]
        [lift_fog]
            [filter]
                id=Vorlyan
            [/filter]
            radius=3
        [/lift_fog]
        [redraw]
        [/redraw]
        [message]
            speaker=Vorlyan
            message= _ "Flying monsters are approaching; sound the alarm!"
        [/message]
    [/event]

    [event]
        name=moveto
        first_time_only=no
        [filter]
            side=1
            [filter_location]
                [filter_adjacent_location]
                    terrain=*^Eb
                [/filter_adjacent_location]
            [/filter_location]
        [/filter]
        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message= _ "Do you want to light the brazier?"
            variable=answer
            [option]
                description= _ "No"
                default=yes
                [command]
                    [allow_undo]
                    [/allow_undo]
                [/command]
            [/option]
            [option]
                description= _ "Yes"
                [command]
                    [if]
                        [have_unit]
                            id=$unit.id
                            [has_attack]
                                name=fire breath
                            [/has_attack]
                        [/have_unit]
                        [then]
                            [animate_unit]
                                [filter]
                                    id=$unit.id
                                [/filter]
                                flag=attack
                                [primary_attack]
                                    name=fire breath
                                [/primary_attack]
                                [facing]
                                    terrain=*^Eb
                                [/facing]
                            [/animate_unit]
                        [/then]
                        [else]
                            [animate_unit]
                                [filter]
                                    id=$unit.id
                                [/filter]
                                flag=attack
                                [primary_attack]
                                    range=melee
                                [/primary_attack]
                                [facing]
                                    terrain=*^Eb
                                [/facing]
                            [/animate_unit]
                        [/else]
                    [/if]
                    # Light the brazier
                    [terrain]
                        terrain=^Ebn
                        [and] # Filtering via old terrain
                            terrain=*^Eb
                        [/and]
                        layer=overlay
                    [/terrain]
                [/command]
            [/option]
        [/message]
    [/event]

    # When the brazier is lit, Kerath appears
    [event]
        name=side turn
        [filter_condition]
            [have_location]
                terrain=*^Ebn
            [/have_location]
        [/filter_condition]
        {UNIT 3 (Sky Drake)     05 01 (facing=se)}
        {UNIT 3 (Drake Warrior) 05 02 (facing=se)}
        {UNIT 3 (Fire Drake)    05 03 (facing=se)}
        # wmllint: who KERATH is Kerath
        [unit]
            {KERATH (Drake Blademaster) BUFF1={AMLA_DEFAULT}}
            side=3
            facing=se
            canrecruit=yes
            x,y=5,4
        [/unit]
        {UNIT 3 (Fire Drake)    04 04 (facing=se)}
        {UNIT 3 (Drake Warrior) 03 05 (facing=se)}
        {UNIT 3 (Sky Drake)     02 05 (facing=se)}
        [scroll_to_unit]
            id=Kerath
        [/scroll_to_unit]
        [delay]
            time=1500
        [/delay]
    [/event]

    [event]
        name=last breath
        [filter]
            id=Vorlyan
        [/filter]
        [message]
            speaker=unit
            message= _ "You will not enjoy your victory long. The Crown will retake this city."
        [/message]
    [/event]

    # Check if no enemy units left
    [event]
        name=die
        [filter_condition]
            [not]
                [have_unit]
                    side=2
                [/have_unit]
            [/not]
        [/filter_condition]
        [endlevel]
            result=victory
        [/endlevel]
    [/event]

    [event]
        name=victory
        [message]
            speaker=Vank
            message= _ "These runners look and taste like the ones back on Morogor."
        [/message]
        [message]
            speaker=Galun
            message= _ "Yes, but they are more organized and dangerous. Their leader was very confident about this ’Crown’; continuing to hunt them could be a problem."
        [/message]
    [/event]
[/scenario]
