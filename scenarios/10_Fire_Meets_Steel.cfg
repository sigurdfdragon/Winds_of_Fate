#textdomain wesnoth-wov
# To make this map do the following conversions to HM_Master.map:
# Cut the top 12 rows of hexes from the map
# Cut the leftmost 24 columns of hexes from the map
# Set the snow covered encampment keep to player 2
# Kh->Kha, Ch->Cha - Player 1 castle to snowy human castle
# Mm,Ko,Co->Ms, Hh->Ha, Fp->Fpa, Gs->Aa, Ww->Ai, Vc->Vca - Make map snowy
# Note: Dry terrain and tropical water is used on HM_Master next to lava flows, so they are
# not converted to snow, to provide additional mobility for the dwarves to start with.
#
# This scenario is intended to be hard difficulty and to allow recalling of many burner & fighter veterans.
[scenario]
    id=10_Fire_Meets_Steel
    name= _ "Fire Meets Steel"
    next_scenario=11_Confrontation
    {WOV_MAP 10_Fire_Meets_Steel.map}
    {TURNS 30 30 30}
    {WINTER_SCHEDULE_MIDDAY}
    carryover_percentage=0

    {INTRO_AND_SCENARIO_MUSIC revelation.ogg revelation.ogg}
    {LET_INTRO_MUSIC_FINISH} # real scenario music set in start

    [story]
        [part]
            background=story/landscape-mountains-snow.jpg
            story= _ "A storm of ice fell upon the sunreach peaks. The greatland’s season of cold had come to sojourn the flight. Gorlack had the camp fortified with great stone works until it resembled an eyrie. With the ample provisions, this season might be outlasted."
        [/part]
        [part]
            background=story/landscape-mountains-snow.jpg
            story= _ "Gorlack secluded himself to a small abode atop the highest peak within sight of camp. There he remained in deep contemplation. Each day Zedrix trekked up the peak to bring his dragon sustenance."
        [/part]
    [/story]
    {WOV_GC_TRACK {JOURNEY_10_NEW}}

    # wmllint: validate-off
    [side]
        side=1
        controller=human
        recruit=Drake Burner, Drake Clasher, Drake Fighter, Drake Glider, Saurian Augur, Saurian Skirmisher
        gold=200 # Player should have at least 100 carryover from previous scenario
        income=4 # More income since the eyrie has been established
        save_id=Player
        team_name=hero
        user_team_name= _ "Drakes"
        side_name= _ "Gorlack"
        {FLAG_VARIANT long}
        [leader]
            {GORLACK}
        [/leader]
        [unit]
            {ARINEXIS}
            placement=leader
        [/unit]
        [unit]
            {ZEDRIX}
            placement=leader
        [/unit]
    [/side]
    {STARTING_VILLAGES 1 5}
    {SECOND_INTENDANT_REPLACEMENT_EVENTS}
    {WOV_DEATHS}

    [side]
        side=2
        controller=ai
        recruit=Gryphon Rider, Gryphon Master
        {GOLD 225 450 675}
        {INCOME 11 22 33}
        team_name=dwarves
        user_team_name= _ "Dwarves"
        {FLAG_VARIANT knalgan}
        [leader]
            id=Thurdakor
            name= _ "Thurdakor"
            type=Dwarvish Berserker
            [modifications]
                {TRAIT_STRONG}
                {TRAIT_RESILIENT}
                {AMLA_DEFAULT}
                {AMLA_DEFAULT}
                {AMLA_DEFAULT}
            [/modifications]
            facing=nw
        [/leader]
        {LOYAL_UNIT () (Dwarvish Dragonguard) 16 31} {GUARDIAN} {FACING sw}
        {LOYAL_UNIT () (Dwarvish Dragonguard) 17 29} {GUARDIAN} {FACING nw}
        {LOYAL_UNIT () (Dwarvish Dragonguard) 19 32} {GUARDIAN} {FACING se}
        {LOYAL_UNIT () (Dwarvish Dragonguard) 20 29} {GUARDIAN} {FACING ne}
        [ai]
            recruitment_pattern=1,2
        [/ai]
    [/side]
    {STARTING_VILLAGES 2 5}
    # wmllint: validate-on

    # Dwarf hole code
    [event]
        name=prestart
        [set_variables]
            name=holes
            mode=replace
            [value]
                x,y=5,17
            [/value]
            [value]
                x,y=8,16
            [/value]
            [value]
                x,y=13,16
            [/value]
            [value]
                x,y=15,15
            [/value]
            [value]
                x,y=22,13
            [/value]
            [value]
                x,y=23,12
            [/value]
        [/set_variables]
        [foreach]
            array=holes
            [do]
                {PLACE_IMAGE scenery/trapdoor-open.png $this_item.x $this_item.y}
                {RANDOM "Dwarvish Fighter,Dwarvish Guardsman,Dwarvish Thunderer"}
                {UNIT 2 $random $this_item.x $this_item.y (moves=0)} {FACING nw}
                [event]
                    name=moveto
                    delayed_variable_substitution=no
                    [filter]
                        side=1
                        x,y=$this_item.x,$this_item.y
                    [/filter]

                    [sound]
                        name=mud-fist.ogg
                    [/sound]
                    {REMOVE_IMAGE $this_item.x $this_item.y}
                    [modify_unit]
                        [filter]
                            x,y=$this_item.x,$this_item.y
                        [/filter]
                        moves=0
                        attacks_left=0
                    [/modify_unit]
                    {VARIABLE holes[$i].filled yes}
                [/event]
            [/do]
        [/foreach]
    [/event]

#define DWARF_RECRUIT_MANAGEMENT
        [foreach]
            array=holes
            [do]
                [if]
                    [not]
                        [have_unit]
                            x,y=$this_item.x,$this_item.y
                        [/have_unit]
                    [/not]
                    [and]
                        {VARIABLE_CONDITIONAL this_item.filled boolean_equals no}
                    [/and]
                    [then]
                        [set_variables]
                            name=available_holes
                            mode=append
                            [value]
                                x,y=$this_item.x,$this_item.y
                            [/value]
                        [/set_variables]
                    [/then]
                [/if]
            [/do]
        [/foreach]
        [if]
            {VARIABLE_CONDITIONAL available_holes.length greater_than 0}
            [then]
                [set_recruit]
                    side=2
                    recruit=Dwarvish Fighter, Dwarvish Steelclad, Dwarvish Guardsman, Dwarvish Stalwart, Dwarvish Thunderer, Dwarvish Thunderguard, Dwarvish Ulfserker, Dwarvish Berserker, Dwarvish Runesmith
                [/set_recruit]
            [/then]
            [else]
                [if]
                    [have_unit]
                        type=Gryphon Rider, Gryphon Master
                        count=$(10-$holes.length)
                    [/have_unit]
                    [then]
                        [set_recruit]
                            side=2
                            recruit=""
                        [/set_recruit]
                    [/then]
                    [else]
                        [set_recruit]
                            side=2
                            recruit=Gryphon Rider, Gryphon Master
                        [/set_recruit]
                    [/else]
                [/if]
            [/else]
        [/if]
        {CLEAR_VARIABLE available_holes}
#enddef
    [event]
        name=side 2 turn refresh
        first_time_only=no
        {DWARF_RECRUIT_MANAGEMENT}
    [/event]

    [event]
        name=recruit, moveto
        first_time_only=no
        [filter]
            side=2
        [/filter]
        {DWARF_RECRUIT_MANAGEMENT}
    [/event]

    # if dwarf recruited, move it to a hole
    [event]
        name=prerecruit
        first_time_only=no
        [filter]
            side=2
            [not]
                type=Gryphon Rider, Gryphon Master
            [/not]
        [/filter]
        # store currently empty holes
        [foreach]
            array=holes
            [do]
                [if]
                    [not]
                        [have_unit]
                            x,y=$this_item.x,$this_item.y
                        [/have_unit]
                    [/not]
                    [and]
                        {VARIABLE_CONDITIONAL this_item.filled boolean_equals no}
                    [/and]
                    [then]
                        [set_variables]
                            name=available_holes
                            mode=append
                            [value]
                                x,y=$this_item.x,$this_item.y
                            [/value]
                        [/set_variables]
                    [/then]
                [/if]
            [/do]
        [/foreach]
        # move unit to empty hole randomly
        {RANDOM "0..$($available_holes.length-1)"}
        {TELEPORT_UNIT id=$unit.id $available_holes[$random].x $available_holes[$random].y}
        {MODIFY_UNIT id=$unit.id facing nw}
        {CLEAR_VARIABLE available_holes,random}
    [/event]
    # End of dwarf hole events

    [event]
        name=prestart
        {MODIFY_UNIT side=1 facing se}

        [objectives]
            [objective]
                description= _ "Survive for five days (30 Turns)"
                condition=win
            [/objective]
            {OBJECTIVE_OR}
            [objective]
                description= _ "Defeat Thurdakor"
                condition=win
            [/objective]
            [objective]
                description= _ "Death of Gorlack"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Arinexis"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Zedrix"
                condition=lose
            [/objective]
            [gold_carryover]
                carryover_percentage=0
            [/gold_carryover]
            [note]
                description= _ "Deep dwellers emerge from each hole until it is filled in. (Move a unit onto the hole tile to fill it in.)"
            [/note]
            [note]
                description= _ "A unit that fills in a hole will be unable to move or attack for the rest of the turn."
            [/note]
            [note]
                description= _ "A winter time schedule is in effect."
            [/note]
        [/objectives]
        # Prepare for starting dialog
        {TELEPORT_UNIT id=Gorlack  09 02}
        {TELEPORT_UNIT id=Zedrix 08 02}
        [put_to_recall_list]
            id=Arinexis
        [/put_to_recall_list]
        [modify_side]
            side=1
            shroud=yes
        [/modify_side]
    [/event]

    [event]
        name=start
        [message]
            speaker=Zedrix
            message= _ "I sssee now you are not Shek’kahan. I ssaw as I wanted to ssee."
        [/message]
        [message]
            speaker=Gorlack
            message= _ "As have I…"
        [/message]
        [message]
            speaker=Zedrix
            message= _ "What do you mean?"
        [/message]
        [message]
            speaker=Gorlack
            message= _ "As a fledgling long ago… I strayed far from the eyrie, lost in dreams of glorious things to be. From a cave nearby I heard cries. My friend Reshan had happened upon a dishonored rogue hiding within. It sought his death to keep secret its presence there. It had cornered him."
        [/message]
        [message]
            speaker=Gorlack
            message= _ "I thought myself invulnerable, the hero in my own tale. I charged at the beast, striking with bare claws. Spiting feeble sparks. With one swipe I was sent to the ground, bleeding."
        [/message]
        [message]
            speaker=Gorlack
            message= _ "My body froze me as it readied to flee. The desire to flee was overcoming. Flee… abandon Reshan to die…"
        [/message]
        [message]
            speaker=Gorlack
            message= _ "The agonizing guilt of that last thought. Leave my friend to die. It reignited my heart with an unfamiliar passion. I would do anything to save my friend. I felt the whole world around me burning for the means to save him. That is when I felt it beneath my right wing. A clasher’s spear, broken a reach beneath the head. It had not been there when I entered the cave. It was there now."
        [/message]
        [message]
            speaker=Gorlack
            message= _ "The rogue turned to finish Reshan. I threw myself upon it with all my hate. The spear I ran deep into its cold heart."
        [/message]
        [message]
            speaker=Gorlack
            message= _ "Ever since have I trusted absolutely in the fire that saved my friend…
Ever since have I fled the fear that drove me toward such vile cowardice."
        [/message]
        [message]
            speaker=Zedrix
            message= _ "You shunned Reshan’s fearss too."
        [/message]
        [message]
            speaker=Gorlack
            message= _ "Breathing in his fears could chill my heart to cowardice."
        [/message]
        [message]
            speaker=Zedrix
            message= _ "Yet hisss heart was brave. Hisss fear for you made it sso."
        [/message]
        [message]
            speaker=Gorlack
            message= _ "…… It did."
        [/message]
        [message]
            speaker=Zedrix
            message= _ "Your fear for him made you brave."
        [/message]
        [message]
            speaker=Gorlack
            message= _ "A discarded spear made me brave."
        [/message]
        [message]
            speaker=Zedrix
            message= _ "The meanss to ssave your friend. It appeared <b>as</b> you feared for him. Becaussse you did."
        [/message]
        [message]
            speaker=Gorlack
            message= _ "…………"
        [/message]
        [sound]
            name=horn-signals/horn-1.ogg
        [/sound]
        [delay]
            time=4500
        [/delay]
        {REPLACE_SCENARIO_MUSIC knalgan_theme.ogg}
        {APPEND_MUSIC           frantic.ogg}
        {APPEND_MUSIC           casualties_of_war.ogg}
        [recall]
            id=Arinexis
            x,y=7,6
        [/recall]
        [message]
            speaker=Arinexis
            message= _ "Come ssswiftly! Deep dwellersss emerge!"
        [/message]
        [modify_side]
            side=1
            shroud=no
        [/modify_side]
        [delay]
            time=2000
        [/delay]
        [sound]
            name=horn-signals/horn-3.ogg
        [/sound]
        [delay]
            time=4500
        [/delay]
        [message]
            speaker=Thurdakor
            image_pos=right
            mirror=yes
            message= _ "Sae whit hae we 'ere? Dragons... Sae mony dragons mah een cannae hawp whit they're seeing."
        [/message]
        # play berserker animation where he takes swig from flask
        [scroll_to_unit]
            id=Thurdakor
        [/scroll_to_unit]
        # zoom in?
        [delay]
            time=500
        [/delay]
        [animate_unit]
            flag=idling
            [filter]
                id=Thurdakor
            [/filter]
        [/animate_unit]
        [delay]
            time=500
        [/delay]
        [message]
            speaker=Arinexis
            message= _ "It ssspeakss but I hear no wordsss… deep dwellersss mussst be drunken."
        [/message]
        [message]
            speaker=Zedrix
            message= _ "It sssaid “dragonss” and… sssomething about dragonsss."
        [/message]
        [message]
            speaker=Thurdakor
            image_pos=right
            mirror=yes
            message= _ "A' richt, noo ye listen tae me, dragons. Ah cannae hae ye juist standing aroond th' hail winter dumping yer ye-ken-whit oan th' frozen slopes, whilk come spring, wull mak' fur a stowed oot knalgan gusher, if ye ken whit ah mean."
        [/message]
        [sound]
            name=horn-signals/horn-4.ogg
        [/sound]
        [delay]
            time=4500
        [/delay]
        [message]
            speaker=Gorlack
            message= _ "I do not grasp the words you speak. Use fewer of them with less haste."
        [/message]
        [message]
            speaker=Thurdakor
            image_pos=right
            mirror=yes
            message= _ "Noo juist whit in th' fiendish skies ‘boon is that suppose tae mean?! Ah wull hae ye ken…"
        [/message]
        [sound]
            name=horn-signals/horn-5.ogg
        [/sound]
        [delay]
            time=4500
        [/delay]
        [message]
            speaker=Arinexis
            message= _ "Your hornblower ssspewss notesss over your wordsss!"
        [/message]
        [message]
            speaker=Thurdakor
            image_pos=right
            mirror=yes
            message= _ "Juist dingy him, he hud awfy much tae dram."
        [/message]
        [message]
            speaker=Gorlack
            message= _ "If you depart now no harm will come to you."
        [/message]
        [message]
            speaker=Thurdakor
            image_pos=right
            mirror=yes
            message= _ "Weel that is it then, wee jimmies. Ye a' saw howfur ah tried tae be reasonable. Bit thare is na reasoning wi' dragons. Thay ainlie ken th' bite o' oor axes."
        [/message]
        [sound]
            name=horn-signals/horn-7.ogg
        [/sound]
        [delay]
            time=4500
        [/delay]
    [/event]

    [event]
        name=time over
        [fire_event]
            name=victory
        [/fire_event]
    [/event]

    [event]
        name=last breath
        [filter]
            id=Thurdakor
        [/filter]

        {MODIFY_UNIT id=$unit.id hitpoints 1}
        [fire_event]
            name=victory
        [/fire_event]
    [/event]

    [event]
        name=victory
        [message]
            speaker=Gorlack
            message= _ "Behold what ends you have wrought. You can no easier cast us off these peaks than we could pluck you from the deep."
        [/message]
        [message]
            speaker=Gorlack
            message= _ "I offer you this pact. All the peaks are our domain. For our metal works, the soils within. The vast under world beneath these we will not violate. Both of us may hunt the lowlands so long as one takes not the other as game."
        [/message]
        [message]
            speaker=Thurdakor
            image_pos=right
            mirror=yes
            message= _ "Nae sure ah like the sound o' this deal."
        [/message]
        [message]
            speaker=Gorlack
            message= _ "It is the best you will have. We covet the soil as little as you do the clouds. We will find no better neighbors than each other."
        [/message]
        [message]
            speaker=Thurdakor
            image_pos=right
            mirror=yes
            message= _ "Yer nae easy tae haggle with, dragon."
        [/message]
        [message]
            speaker=Thurdakor
            image_pos=right
            mirror=yes
            message= _ "Sae be it, a deal we hae. Ah wull even release mah prize wee dragon captive fur ye."
        [/message]
        # store Thurdakor's current location
        [store_unit]
            [filter]
                id=Thurdakor
            [/filter]
            variable=loc
        [/store_unit]
        # find nearest unoccupied - chance that they are all full is remote
        [store_reachable_locations]
            [filter]
                id=Thurdakor
            [/filter]
            [filter_location]
                terrain=Rd,Hhd,Md,Cea
                [not]
                    [filter]
                    [/filter]
                [/not]
            [/filter_location]
            range=vision
            moves=max
            variable=hole
        [/store_reachable_locations]
        # use first hole option and move Thurdakor to it
        [move_unit]
            id=Thurdakor
            to_x,to_y=$hole.x,$hole.y
        [/move_unit]
        # place hole
        {PLACE_IMAGE scenery/burrow.png $hole.x $hole.y}
        # move Thurdakor back to where he was
        [move_unit]
            id=Thurdakor
            to_x,to_y=$loc.x,$loc.y
        [/move_unit]
        {CLEAR_VARIABLE loc}
        [delay]
            time=1000
        [/delay]
        # have Reshan appear at hole
        [if]
            {VARIABLE_CONDITIONAL reshan.id not_equals $null}
            [then]
                [unstore_unit]
                    variable=reshan
                    x,y=$hole.x,$hole.y
                    find_vacant=yes
                [/unstore_unit]
            [/then]
            [else]
                [unit]
                    {RESHAN}
                    type=Hurricane Drake # overwrites key in macro
                    x,y=$hole.x,$hole.y
                [/unit]
            [/else]
        [/if]
        [delay]
            time=1000
        [/delay]
        # TODO: find a hex near Gorlack ensuring the hex is not the hole that reshan just appeared at
        # shortcut for TODO for now
        [store_unit]
            [filter]
                id=Gorlack
            [/filter]
            variable=loc
        [/store_unit]
        # move Reshan to that hex
        [move_unit]
            id=Reshan
            to_x,to_y=$loc.x,$loc.y
        [/move_unit]
        # TODO: Add facing adjustments for Gorlack & Reshan
        {CLEAR_VARIABLE loc}
        [message]
            speaker=Reshan
            message= _ "Gorlack, it seems no cave can keep us!"
        [/message]
        [message]
            speaker=Gorlack
            message= _ "reshan…

Reshan!"
        [/message]
        [message]
            speaker=Thurdakor
            image_pos=right
            mirror=yes
            message= _ "Well, that is it fur me, back doon th' shute."
        [/message]
        # Move Thur to the hole reshan came from and have him and the rest of the dwarves disappear
        [move_unit]
            id=Thurdakor
            to_x,to_y=$hole.x,$hole.y
        [/move_unit]
        [kill]
            side=2
        [/kill]
        [sound]
            name=mud-fist.ogg
        [/sound]
        {REMOVE_IMAGE $hole.x $hole.y}
        {CLEAR_VARIABLE hole}
        [delay]
            time=1000
        [/delay]
        [message]
            speaker=Reshan
            message= _ "The deep dwellers hewed through my tomb of broken stone to discover me. I was to be their captive in the underworld forever. A curio to frighten their hatchlings from straying to the above. By your pact with them, I was freed.

My friend, I am once again in your debt."
        [/message]
        [message]
            speaker=Gorlack
            message= _ "Nay, Reshan, it is I that owes you."
        [/message]

        [message]
            speaker=Gorlack
            message= _ "We have much to plan for the Future of our Folk in this Greatland."
        [/message]
    [/event]
[/scenario]
